# 🚨 告警规则配置 - AI语音政治风险监控系统
# 智能告警和故障检测

groups:
  # 🚨 系统级别告警
  - name: system.rules
    rules:
      # CPU使用率过高
      - alert: HighCpuUsage
        expr: audio_ai:cpu_usage_percent > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "CPU使用率过高"
          description: "实例 {{ $labels.instance }} CPU使用率超过80%，当前值: {{ $value }}%"

      # 内存使用率过高
      - alert: HighMemoryUsage
        expr: audio_ai:memory_usage_percent > 85
        for: 3m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "内存使用率过高"
          description: "实例 {{ $labels.instance }} 内存使用率超过85%，当前值: {{ $value }}%"

      # 磁盘空间不足
      - alert: LowDiskSpace
        expr: audio_ai:disk_usage_percent > 90
        for: 1m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "磁盘空间严重不足"
          description: "实例 {{ $labels.instance }} 磁盘使用率超过90%，当前值: {{ $value }}%"

      # 系统负载过高
      - alert: HighSystemLoad
        expr: node_load1 > node_nprocs * 1.5
        for: 10m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "系统负载过高"
          description: "实例 {{ $labels.instance }} 1分钟负载超过CPU核心数的1.5倍"

  # 🤖 应用级别告警
  - name: application.rules
    rules:
      # 应用服务下线
      - alert: ApplicationDown
        expr: up{job="audio-ai-app"} == 0
        for: 1m
        labels:
          severity: critical
          service: audio-ai
        annotations:
          summary: "AI应用服务下线"
          description: "应用实例 {{ $labels.instance }} 已下线超过1分钟"

      # 高错误率
      - alert: HighErrorRate
        expr: audio_ai:error_rate > 0.1
        for: 5m
        labels:
          severity: warning
          service: audio-ai
        annotations:
          summary: "应用错误率过高"
          description: "应用错误率超过10%，当前值: {{ $value | humanizePercentage }}"

      # 响应时间过长
      - alert: SlowResponseTime
        expr: audio_ai:response_time_avg > 5
        for: 5m
        labels:
          severity: warning
          service: audio-ai
        annotations:
          summary: "应用响应时间过长"
          description: "平均响应时间超过5秒，当前值: {{ $value }}秒"

      # 请求队列积压
      - alert: RequestQueueBacklog
        expr: audio_ai_queue_size > 100
        for: 2m
        labels:
          severity: warning
          service: audio-ai
        annotations:
          summary: "请求队列积压"
          description: "请求队列大小超过100，当前值: {{ $value }}"

  # 🎯 AI模型告警
  - name: ai-model.rules
    rules:
      # GPU使用率异常
      - alert: GpuUsageAnomaly
        expr: audio_ai:gpu_usage_percent > 95
        for: 10m
        labels:
          severity: warning
          service: ai-model
        annotations:
          summary: "GPU使用率持续过高"
          description: "GPU使用率超过95%持续10分钟，当前值: {{ $value }}%"

      # GPU内存不足
      - alert: GpuMemoryLow
        expr: (nvidia_ml_py_memory_used_bytes / nvidia_ml_py_memory_total_bytes) > 0.9
        for: 5m
        labels:
          severity: critical
          service: ai-model
        annotations:
          summary: "GPU内存不足"
          description: "GPU内存使用率超过90%，可能影响模型推理性能"

      # 模型推理延迟过高
      - alert: ModelInferenceDelay
        expr: audio_ai_model_inference_duration_seconds > 30
        for: 3m
        labels:
          severity: warning
          service: ai-model
        annotations:
          summary: "AI模型推理延迟过高"
          description: "模型推理时间超过30秒，当前值: {{ $value }}秒"

      # 模型推理失败率高
      - alert: ModelInferenceFailure
        expr: rate(audio_ai_model_inference_failures_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          service: ai-model
        annotations:
          summary: "AI模型推理失败率过高"
          description: "模型推理失败率超过5%，需要检查模型状态"

  # 🗄️ 数据库告警
  - name: database.rules
    rules:
      # MongoDB连接数过高
      - alert: MongoHighConnections
        expr: mongodb_connections{state="current"} > 800
        for: 5m
        labels:
          severity: warning
          service: mongodb
        annotations:
          summary: "MongoDB连接数过高"
          description: "MongoDB当前连接数超过800，当前值: {{ $value }}"

      # Redis内存使用率过高
      - alert: RedisHighMemoryUsage
        expr: (redis_memory_used_bytes / redis_memory_max_bytes) > 0.8
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis内存使用率过高"
          description: "Redis内存使用率超过80%，当前值: {{ $value | humanizePercentage }}"

      # 数据库响应时间过长
      - alert: DatabaseSlowQueries
        expr: mongodb_op_latencies_histogram > 1000
        for: 5m
        labels:
          severity: warning
          service: mongodb
        annotations:
          summary: "数据库查询响应时间过长"
          description: "数据库查询延迟超过1秒"

  # 🌐 网络告警
  - name: network.rules
    rules:
      # 网络带宽使用率过高
      - alert: HighNetworkTraffic
        expr: rate(node_network_receive_bytes_total[5m]) + rate(node_network_transmit_bytes_total[5m]) > 100*1024*1024
        for: 5m
        labels:
          severity: warning
          service: network
        annotations:
          summary: "网络流量过高"
          description: "网络流量超过100MB/s"

      # TCP连接数异常
      - alert: HighTcpConnections
        expr: node_netstat_Tcp_CurrEstab > 10000
        for: 5m
        labels:
          severity: warning
          service: network
        annotations:
          summary: "TCP连接数过多"
          description: "当前TCP连接数超过10000"

  # 🔐 安全告警
  - name: security.rules
    rules:
      # 异常登录尝试
      - alert: SuspiciousLoginAttempts
        expr: increase(audio_ai_failed_login_attempts_total[5m]) > 10
        for: 1m
        labels:
          severity: critical
          service: security
        annotations:
          summary: "检测到异常登录尝试"
          description: "5分钟内失败登录尝试超过10次，可能存在安全威胁"

      # 文件上传异常
      - alert: SuspiciousFileUploads
        expr: increase(audio_ai_suspicious_uploads_total[1h]) > 5
        for: 1m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "检测到可疑文件上传"
          description: "1小时内可疑文件上传超过5次"

  # 🔧 业务指标告警
  - name: business.rules
    rules:
      # 音频处理积压
      - alert: AudioProcessingBacklog
        expr: audio_ai_pending_audio_files > 50
        for: 10m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "音频处理任务积压"
          description: "待处理音频文件数量超过50个，当前值: {{ $value }}"

      # 每日处理量异常
      - alert: DailyProcessingVolumeAnomaly
        expr: |
          (
            rate(audio_ai_processed_files_total[24h]) - 
            rate(audio_ai_processed_files_total[24h] offset 7d)
          ) / rate(audio_ai_processed_files_total[24h] offset 7d) < -0.5
        for: 1h
        labels:
          severity: warning
          service: business
        annotations:
          summary: "每日处理量异常下降"
          description: "今日处理量比上周同期下降超过50%"

      # 风险检测率异常
      - alert: RiskDetectionRateAnomaly
        expr: |
          (
            rate(audio_ai_risk_detected_total[1h]) / 
            rate(audio_ai_processed_files_total[1h])
          ) > 0.8
        for: 30m
        labels:
          severity: critical
          service: business
        annotations:
          summary: "风险检测率异常升高"
          description: "过去1小时风险检测率超过80%，可能存在系统异常或真实风险激增"
