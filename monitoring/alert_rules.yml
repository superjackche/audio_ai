# ğŸš¨ å‘Šè­¦è§„åˆ™é…ç½® - AIè¯­éŸ³æ”¿æ²»é£é™©ç›‘æ§ç³»ç»Ÿ
# æ™ºèƒ½å‘Šè­¦å’Œæ•…éšœæ£€æµ‹

groups:
  # ğŸš¨ ç³»ç»Ÿçº§åˆ«å‘Šè­¦
  - name: system.rules
    rules:
      # CPUä½¿ç”¨ç‡è¿‡é«˜
      - alert: HighCpuUsage
        expr: audio_ai:cpu_usage_percent > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "CPUä½¿ç”¨ç‡è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} CPUä½¿ç”¨ç‡è¶…è¿‡80%ï¼Œå½“å‰å€¼: {{ $value }}%"

      # å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜
      - alert: HighMemoryUsage
        expr: audio_ai:memory_usage_percent > 85
        for: 3m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡85%ï¼Œå½“å‰å€¼: {{ $value }}%"

      # ç£ç›˜ç©ºé—´ä¸è¶³
      - alert: LowDiskSpace
        expr: audio_ai:disk_usage_percent > 90
        for: 1m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "ç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³"
          description: "å®ä¾‹ {{ $labels.instance }} ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œå½“å‰å€¼: {{ $value }}%"

      # ç³»ç»Ÿè´Ÿè½½è¿‡é«˜
      - alert: HighSystemLoad
        expr: node_load1 > node_nprocs * 1.5
        for: 10m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "ç³»ç»Ÿè´Ÿè½½è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} 1åˆ†é’Ÿè´Ÿè½½è¶…è¿‡CPUæ ¸å¿ƒæ•°çš„1.5å€"

  # ğŸ¤– åº”ç”¨çº§åˆ«å‘Šè­¦
  - name: application.rules
    rules:
      # åº”ç”¨æœåŠ¡ä¸‹çº¿
      - alert: ApplicationDown
        expr: up{job="audio-ai-app"} == 0
        for: 1m
        labels:
          severity: critical
          service: audio-ai
        annotations:
          summary: "AIåº”ç”¨æœåŠ¡ä¸‹çº¿"
          description: "åº”ç”¨å®ä¾‹ {{ $labels.instance }} å·²ä¸‹çº¿è¶…è¿‡1åˆ†é’Ÿ"

      # é«˜é”™è¯¯ç‡
      - alert: HighErrorRate
        expr: audio_ai:error_rate > 0.1
        for: 5m
        labels:
          severity: warning
          service: audio-ai
        annotations:
          summary: "åº”ç”¨é”™è¯¯ç‡è¿‡é«˜"
          description: "åº”ç”¨é”™è¯¯ç‡è¶…è¿‡10%ï¼Œå½“å‰å€¼: {{ $value | humanizePercentage }}"

      # å“åº”æ—¶é—´è¿‡é•¿
      - alert: SlowResponseTime
        expr: audio_ai:response_time_avg > 5
        for: 5m
        labels:
          severity: warning
          service: audio-ai
        annotations:
          summary: "åº”ç”¨å“åº”æ—¶é—´è¿‡é•¿"
          description: "å¹³å‡å“åº”æ—¶é—´è¶…è¿‡5ç§’ï¼Œå½“å‰å€¼: {{ $value }}ç§’"

      # è¯·æ±‚é˜Ÿåˆ—ç§¯å‹
      - alert: RequestQueueBacklog
        expr: audio_ai_queue_size > 100
        for: 2m
        labels:
          severity: warning
          service: audio-ai
        annotations:
          summary: "è¯·æ±‚é˜Ÿåˆ—ç§¯å‹"
          description: "è¯·æ±‚é˜Ÿåˆ—å¤§å°è¶…è¿‡100ï¼Œå½“å‰å€¼: {{ $value }}"

  # ğŸ¯ AIæ¨¡å‹å‘Šè­¦
  - name: ai-model.rules
    rules:
      # GPUä½¿ç”¨ç‡å¼‚å¸¸
      - alert: GpuUsageAnomaly
        expr: audio_ai:gpu_usage_percent > 95
        for: 10m
        labels:
          severity: warning
          service: ai-model
        annotations:
          summary: "GPUä½¿ç”¨ç‡æŒç»­è¿‡é«˜"
          description: "GPUä½¿ç”¨ç‡è¶…è¿‡95%æŒç»­10åˆ†é’Ÿï¼Œå½“å‰å€¼: {{ $value }}%"

      # GPUå†…å­˜ä¸è¶³
      - alert: GpuMemoryLow
        expr: (nvidia_ml_py_memory_used_bytes / nvidia_ml_py_memory_total_bytes) > 0.9
        for: 5m
        labels:
          severity: critical
          service: ai-model
        annotations:
          summary: "GPUå†…å­˜ä¸è¶³"
          description: "GPUå†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œå¯èƒ½å½±å“æ¨¡å‹æ¨ç†æ€§èƒ½"

      # æ¨¡å‹æ¨ç†å»¶è¿Ÿè¿‡é«˜
      - alert: ModelInferenceDelay
        expr: audio_ai_model_inference_duration_seconds > 30
        for: 3m
        labels:
          severity: warning
          service: ai-model
        annotations:
          summary: "AIæ¨¡å‹æ¨ç†å»¶è¿Ÿè¿‡é«˜"
          description: "æ¨¡å‹æ¨ç†æ—¶é—´è¶…è¿‡30ç§’ï¼Œå½“å‰å€¼: {{ $value }}ç§’"

      # æ¨¡å‹æ¨ç†å¤±è´¥ç‡é«˜
      - alert: ModelInferenceFailure
        expr: rate(audio_ai_model_inference_failures_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          service: ai-model
        annotations:
          summary: "AIæ¨¡å‹æ¨ç†å¤±è´¥ç‡è¿‡é«˜"
          description: "æ¨¡å‹æ¨ç†å¤±è´¥ç‡è¶…è¿‡5%ï¼Œéœ€è¦æ£€æŸ¥æ¨¡å‹çŠ¶æ€"

  # ğŸ—„ï¸ æ•°æ®åº“å‘Šè­¦
  - name: database.rules
    rules:
      # MongoDBè¿æ¥æ•°è¿‡é«˜
      - alert: MongoHighConnections
        expr: mongodb_connections{state="current"} > 800
        for: 5m
        labels:
          severity: warning
          service: mongodb
        annotations:
          summary: "MongoDBè¿æ¥æ•°è¿‡é«˜"
          description: "MongoDBå½“å‰è¿æ¥æ•°è¶…è¿‡800ï¼Œå½“å‰å€¼: {{ $value }}"

      # Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜
      - alert: RedisHighMemoryUsage
        expr: (redis_memory_used_bytes / redis_memory_max_bytes) > 0.8
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "Rediså†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%ï¼Œå½“å‰å€¼: {{ $value | humanizePercentage }}"

      # æ•°æ®åº“å“åº”æ—¶é—´è¿‡é•¿
      - alert: DatabaseSlowQueries
        expr: mongodb_op_latencies_histogram > 1000
        for: 5m
        labels:
          severity: warning
          service: mongodb
        annotations:
          summary: "æ•°æ®åº“æŸ¥è¯¢å“åº”æ—¶é—´è¿‡é•¿"
          description: "æ•°æ®åº“æŸ¥è¯¢å»¶è¿Ÿè¶…è¿‡1ç§’"

  # ğŸŒ ç½‘ç»œå‘Šè­¦
  - name: network.rules
    rules:
      # ç½‘ç»œå¸¦å®½ä½¿ç”¨ç‡è¿‡é«˜
      - alert: HighNetworkTraffic
        expr: rate(node_network_receive_bytes_total[5m]) + rate(node_network_transmit_bytes_total[5m]) > 100*1024*1024
        for: 5m
        labels:
          severity: warning
          service: network
        annotations:
          summary: "ç½‘ç»œæµé‡è¿‡é«˜"
          description: "ç½‘ç»œæµé‡è¶…è¿‡100MB/s"

      # TCPè¿æ¥æ•°å¼‚å¸¸
      - alert: HighTcpConnections
        expr: node_netstat_Tcp_CurrEstab > 10000
        for: 5m
        labels:
          severity: warning
          service: network
        annotations:
          summary: "TCPè¿æ¥æ•°è¿‡å¤š"
          description: "å½“å‰TCPè¿æ¥æ•°è¶…è¿‡10000"

  # ğŸ” å®‰å…¨å‘Šè­¦
  - name: security.rules
    rules:
      # å¼‚å¸¸ç™»å½•å°è¯•
      - alert: SuspiciousLoginAttempts
        expr: increase(audio_ai_failed_login_attempts_total[5m]) > 10
        for: 1m
        labels:
          severity: critical
          service: security
        annotations:
          summary: "æ£€æµ‹åˆ°å¼‚å¸¸ç™»å½•å°è¯•"
          description: "5åˆ†é’Ÿå†…å¤±è´¥ç™»å½•å°è¯•è¶…è¿‡10æ¬¡ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨å¨èƒ"

      # æ–‡ä»¶ä¸Šä¼ å¼‚å¸¸
      - alert: SuspiciousFileUploads
        expr: increase(audio_ai_suspicious_uploads_total[1h]) > 5
        for: 1m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "æ£€æµ‹åˆ°å¯ç–‘æ–‡ä»¶ä¸Šä¼ "
          description: "1å°æ—¶å†…å¯ç–‘æ–‡ä»¶ä¸Šä¼ è¶…è¿‡5æ¬¡"

  # ğŸ”§ ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
  - name: business.rules
    rules:
      # éŸ³é¢‘å¤„ç†ç§¯å‹
      - alert: AudioProcessingBacklog
        expr: audio_ai_pending_audio_files > 50
        for: 10m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "éŸ³é¢‘å¤„ç†ä»»åŠ¡ç§¯å‹"
          description: "å¾…å¤„ç†éŸ³é¢‘æ–‡ä»¶æ•°é‡è¶…è¿‡50ä¸ªï¼Œå½“å‰å€¼: {{ $value }}"

      # æ¯æ—¥å¤„ç†é‡å¼‚å¸¸
      - alert: DailyProcessingVolumeAnomaly
        expr: |
          (
            rate(audio_ai_processed_files_total[24h]) - 
            rate(audio_ai_processed_files_total[24h] offset 7d)
          ) / rate(audio_ai_processed_files_total[24h] offset 7d) < -0.5
        for: 1h
        labels:
          severity: warning
          service: business
        annotations:
          summary: "æ¯æ—¥å¤„ç†é‡å¼‚å¸¸ä¸‹é™"
          description: "ä»Šæ—¥å¤„ç†é‡æ¯”ä¸Šå‘¨åŒæœŸä¸‹é™è¶…è¿‡50%"

      # é£é™©æ£€æµ‹ç‡å¼‚å¸¸
      - alert: RiskDetectionRateAnomaly
        expr: |
          (
            rate(audio_ai_risk_detected_total[1h]) / 
            rate(audio_ai_processed_files_total[1h])
          ) > 0.8
        for: 30m
        labels:
          severity: critical
          service: business
        annotations:
          summary: "é£é™©æ£€æµ‹ç‡å¼‚å¸¸å‡é«˜"
          description: "è¿‡å»1å°æ—¶é£é™©æ£€æµ‹ç‡è¶…è¿‡80%ï¼Œå¯èƒ½å­˜åœ¨ç³»ç»Ÿå¼‚å¸¸æˆ–çœŸå®é£é™©æ¿€å¢"
