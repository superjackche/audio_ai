# 📊 Prometheus 监控配置 - AI语音政治风险监控系统
# 高级指标收集和告警规则

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'audio-ai-cluster'
    environment: 'production'

# 🚨 告警规则文件
rule_files:
  - "alert_rules.yml"

# 📡 指标收集配置
scrape_configs:
  # 🤖 主应用监控
  - job_name: 'audio-ai-app'
    static_configs:
      - targets: ['audio-ai-app1:8080', 'audio-ai-app2:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s
    scrape_timeout: 8s
    params:
      format: ['prometheus']

  # 🗄️ Redis监控
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-cluster:6379']
    metrics_path: '/metrics'

  # 🍃 MongoDB监控
  - job_name: 'mongodb'
    static_configs:
      - targets: ['mongodb-primary:27017']
    metrics_path: '/metrics'

  # 🌐 HAProxy监控
  - job_name: 'haproxy'
    static_configs:
      - targets: ['haproxy:8404']
    metrics_path: '/stats/prometheus'

  # 🐳 Docker容器监控
  - job_name: 'docker'
    static_configs:
      - targets: ['localhost:9323']

  # 🖥️ 系统监控 (Node Exporter)
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    scrape_interval: 5s

  # 🎯 GPU监控 (NVIDIA GPU)
  - job_name: 'nvidia-gpu'
    static_configs:
      - targets: ['gpu-exporter:9445']
    scrape_interval: 5s

  # 📱 应用程序自定义指标
  - job_name: 'audio-ai-metrics'
    static_configs:
      - targets: ['audio-ai-app1:8080', 'audio-ai-app2:8080']
    metrics_path: '/api/metrics'
    scrape_interval: 30s
    params:
      module: ['audio_processing']

# 🚨 告警管理器配置
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# 📈 记录规则 - 预计算常用查询
recording_rules:
  - name: audio-ai.rules
    rules:
      # CPU使用率
      - record: audio_ai:cpu_usage_percent
        expr: |
          100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
      
      # 内存使用率
      - record: audio_ai:memory_usage_percent
        expr: |
          100 * (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)
      
      # 磁盘使用率
      - record: audio_ai:disk_usage_percent
        expr: |
          100 * (1 - node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})
      
      # GPU使用率
      - record: audio_ai:gpu_usage_percent
        expr: |
          nvidia_ml_py_gpu_utilization_percent
      
      # 应用请求率
      - record: audio_ai:request_rate
        expr: |
          rate(http_requests_total[5m])
      
      # 错误率
      - record: audio_ai:error_rate
        expr: |
          rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])
      
      # 平均响应时间
      - record: audio_ai:response_time_avg
        expr: |
          rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])

# 🎯 服务发现配置
service_discovery_configs:
  - dns_sd_configs:
      - names:
        - 'audio-ai-app1'
        - 'audio-ai-app2'
        type: 'A'
        port: 8080
