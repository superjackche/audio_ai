# ğŸ“Š Prometheus ç›‘æ§é…ç½® - AIè¯­éŸ³æ”¿æ²»é£é™©ç›‘æ§ç³»ç»Ÿ
# é«˜çº§æŒ‡æ ‡æ”¶é›†å’Œå‘Šè­¦è§„åˆ™

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'audio-ai-cluster'
    environment: 'production'

# ğŸš¨ å‘Šè­¦è§„åˆ™æ–‡ä»¶
rule_files:
  - "alert_rules.yml"

# ğŸ“¡ æŒ‡æ ‡æ”¶é›†é…ç½®
scrape_configs:
  # ğŸ¤– ä¸»åº”ç”¨ç›‘æ§
  - job_name: 'audio-ai-app'
    static_configs:
      - targets: ['audio-ai-app1:8080', 'audio-ai-app2:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s
    scrape_timeout: 8s
    params:
      format: ['prometheus']

  # ğŸ—„ï¸ Redisç›‘æ§
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-cluster:6379']
    metrics_path: '/metrics'

  # ğŸƒ MongoDBç›‘æ§
  - job_name: 'mongodb'
    static_configs:
      - targets: ['mongodb-primary:27017']
    metrics_path: '/metrics'

  # ğŸŒ HAProxyç›‘æ§
  - job_name: 'haproxy'
    static_configs:
      - targets: ['haproxy:8404']
    metrics_path: '/stats/prometheus'

  # ğŸ³ Dockerå®¹å™¨ç›‘æ§
  - job_name: 'docker'
    static_configs:
      - targets: ['localhost:9323']

  # ğŸ–¥ï¸ ç³»ç»Ÿç›‘æ§ (Node Exporter)
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    scrape_interval: 5s

  # ğŸ¯ GPUç›‘æ§ (NVIDIA GPU)
  - job_name: 'nvidia-gpu'
    static_configs:
      - targets: ['gpu-exporter:9445']
    scrape_interval: 5s

  # ğŸ“± åº”ç”¨ç¨‹åºè‡ªå®šä¹‰æŒ‡æ ‡
  - job_name: 'audio-ai-metrics'
    static_configs:
      - targets: ['audio-ai-app1:8080', 'audio-ai-app2:8080']
    metrics_path: '/api/metrics'
    scrape_interval: 30s
    params:
      module: ['audio_processing']

# ğŸš¨ å‘Šè­¦ç®¡ç†å™¨é…ç½®
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# ğŸ“ˆ è®°å½•è§„åˆ™ - é¢„è®¡ç®—å¸¸ç”¨æŸ¥è¯¢
recording_rules:
  - name: audio-ai.rules
    rules:
      # CPUä½¿ç”¨ç‡
      - record: audio_ai:cpu_usage_percent
        expr: |
          100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
      
      # å†…å­˜ä½¿ç”¨ç‡
      - record: audio_ai:memory_usage_percent
        expr: |
          100 * (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)
      
      # ç£ç›˜ä½¿ç”¨ç‡
      - record: audio_ai:disk_usage_percent
        expr: |
          100 * (1 - node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})
      
      # GPUä½¿ç”¨ç‡
      - record: audio_ai:gpu_usage_percent
        expr: |
          nvidia_ml_py_gpu_utilization_percent
      
      # åº”ç”¨è¯·æ±‚ç‡
      - record: audio_ai:request_rate
        expr: |
          rate(http_requests_total[5m])
      
      # é”™è¯¯ç‡
      - record: audio_ai:error_rate
        expr: |
          rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])
      
      # å¹³å‡å“åº”æ—¶é—´
      - record: audio_ai:response_time_avg
        expr: |
          rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])

# ğŸ¯ æœåŠ¡å‘ç°é…ç½®
service_discovery_configs:
  - dns_sd_configs:
      - names:
        - 'audio-ai-app1'
        - 'audio-ai-app2'
        type: 'A'
        port: 8080
